<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIGHTNING BLACKJACK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Orbitron', sans-serif; }
        body { background: #0a0a0f; overflow-x: hidden; margin: 0; padding: 0; }
        .lightning-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(ellipse at 20% 30%, rgba(124,58,237,0.15), transparent 50%),
                        radial-gradient(ellipse at 80% 70%, rgba(234,179,8,0.15), transparent 50%);
            animation: pulse 8s ease-in-out infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
        .glow-container {
            background: rgba(10,10,15,0.95);
            border: 2px solid; border-image: linear-gradient(135deg, #fbbf24, #7c3aed, #3b82f6) 1;
            box-shadow: 0 0 30px rgba(251,191,36,0.3), 0 0 60px rgba(124,58,237,0.2);
            border-radius: 1.5rem; padding: 1.5rem; margin: 1rem;
        }
        .btn-glow {
            font-weight: 900; text-transform: uppercase; letter-spacing: 2px;
            padding: 0.75rem 1.5rem; border-radius: 1rem; transition: all 0.3s;
            border: 2px solid; box-shadow: 0 0 20px rgba(251,191,36,0.6);
        }
        .btn-primary { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #0a0a0f; border-color: #fbbf24; }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: white; border-color: #10b981; }
        .text-glow-yellow { color: #fbbf24; text-shadow: 0 0 10px #fbbf24, 0 0 20px #fbbf24; }
        .text-glow-purple { color: #a78bfa; text-shadow: 0 0 10px #7c3aed; }
        .input-glow {
            background: rgba(17,24,39,0.8); border: 2px solid rgba(251,191,36,0.3);
            color: white; padding: 0.75rem; border-radius: 1rem; width: 100%;
        }
        .input-glow:focus { outline: none; border-color: #fbbf24; box-shadow: 0 0 20px rgba(251,191,36,0.5); }
        .qr-container { background: white; padding: 10px; border-radius: 15px; display: inline-block; }
        #withdrawModal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); }
        .modal-content { background: rgba(10,10,15,0.95); margin: 15% auto; padding: 2rem; border-radius: 1.5rem; width: 90%; max-width: 400px; box-shadow: 0 0 50px rgba(251,191,36,0.7); }
        .close { color: #fbbf24; float: right; font-size: 2rem; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div class="lightning-bg"></div>

    <!-- CONFIG -->
    <div id="configSection" class="max-w-md mx-auto mt-10">
        <div class="glow-container">
            <h1 class="text-4xl font-black text-center text-glow-yellow mb-4">LIGHTNING BLACKJACK</h1>
            <input type="text" id="lnbitsUrl" placeholder="URL LNbits" class="input-glow mb-3">
            <input type="password" id="adminKey" placeholder="Clé Admin" class="input-glow mb-3">
            <input type="password" id="invoiceKey" placeholder="Clé Invoice" class="input-glow mb-4">
            <button onclick="saveConfig()" class="w-full btn-glow btn-primary">ACTIVER</button>
        </div>
    </div>

    <!-- PAIEMENT -->
    <div id="paymentSection" class="hidden max-w-md mx-auto mt-10">
        <div class="glow-container text-center">
            <h2 class="text-3xl font-black text-glow-yellow mb-4">ACHETER DES JETONS</h2>
            <div class="grid grid-cols-2 gap-3 mb-6">
                <button onclick="buyChips(2100)" class="p-4 bg-gradient-to-br from-yellow-500 to-amber-600 text-white rounded-xl font-bold">2,100</button>
                <button onclick="buyChips(5000)" class="p-4 bg-gradient-to-br from-blue-600 to-indigo-700 text-white rounded-xl font-bold">5,000</button>
                <button onclick="buyChips(10000)" class="p-4 bg-gradient-to-br from-green-600 to-emerald-700 text-white rounded-xl font-bold">10,000</button>
                <button onclick="buyChips(21000)" class="p-4 bg-gradient-to-br from-purple-600 to-pink-700 text-white rounded-xl font-bold">21,000</button>
            </div>

            <div id="invoiceDisplay" class="hidden">
                <div class="p-4 bg-white rounded-xl inline-block mb-4">
                    <div id="qrCode"></div>
                </div>
                <p class="text-xs break-all text-gray-300 mb-3" id="invoiceText"></p>
                <button onclick="copyInvoice()" class="w-full btn-glow btn-primary mb-2">COPIER</button>
                <button onclick="cancelPayment()" class="text-sm text-gray-400">Annuler</button>
            </div>

            <button onclick="showGame()" class="mt-4 text-glow-purple underline">JOUER</button>
        </div>
    </div>

    <!-- JEU -->
    <div id="gameSection" class="hidden max-w-4xl mx-auto mt-10">
        <div class="glow-container text-center">
            <div class="flex justify-between items-center mb-4 px-4">
                <h1 class="text-3xl font-black text-glow-yellow">LIGHTNING BLACKJACK</h1>
                <div class="text-right">
                    <div class="text-sm text-glow-purple">SOLDE</div>
                    <div class="text-3xl font-black text-glow-yellow" id="balance">0</div>
                    <button onclick="showPayment()" class="btn-glow btn-primary text-xs px-3 py-1 mr-1">ACHETER</button>
                    <button onclick="openWithdrawModal()" id="withdrawBtn" class="btn-glow btn-success text-xs px-3 py-1" style="display:none;">RETRAIT</button>
                </div>
            </div>

            <!-- Zone de mise -->
            <div id="bettingArea" class="mb-6">
                <h3 class="text-xl text-glow-yellow mb-3">MISE</h3>
                <div class="flex justify-center gap-2 flex-wrap mb-3">
                    <button onclick="selectBet(100)" class="w-16 h-16 rounded-full bg-red-600 text-white font-bold">100</button>
                    <button onclick="selectBet(500)" class="w-16 h-16 rounded-full bg-blue-600 text-white font-bold">500</button>
                    <button onclick="selectBet(1000)" class="w-16 h-16 rounded-full bg-green-600 text-white font-bold">1K</button>
                    <button onclick="selectBet(2100)" class="w-16 h-16 rounded-full bg-purple-600 text-white font-bold">2.1K</button>
                </div>
                <div class="text-2xl text-glow-yellow mb-3" id="currentBet">0</div>
                <button onclick="startGame()" class="btn-glow btn-success px-6 py-2">DISTRIBUER</button>
            </div>

            <!-- Cartes -->
            <div id="dealerCards" class="min-h-32 mb-4 flex justify-center gap-2 flex-wrap"></div>
            <div id="playerCards" class="min-h-32 mb-4 flex justify-center gap-2 flex-wrap"></div>

            <!-- Boutons jeu -->
            <div id="gameButtons" class="hidden flex justify-center gap-3">
                <button onclick="hit()" class="btn-glow btn-primary px-6 py-2">CARTE</button>
                <button onclick="stand()" class="btn-glow btn-success px-6 py-2">RESTER</button>
            </div>

            <div id="newGameButton" class="hidden mt-4">
                <button onclick="newGame()" class="btn-glow btn-success px-6 py-2">NOUVELLE PARTIE</button>
            </div>
        </div>
    </div>

    <!-- MODAL RETRAIT -->
    <div id="withdrawModal">
        <div class="modal-content">
            <span class="close" onclick="closeWithdrawModal()">×</span>
            <h3 class="text-2xl text-glow-yellow mb-4">RETRAIT</h3>
            <input type="number" id="withdrawAmount" placeholder="Montant (sats)" class="input-glow mb-3">
            <input type="text" id="withdrawAddress" placeholder="Adresse Lightning" class="input-glow mb-4">
            <button onclick="withdraw()" class="w-full btn-glow btn-success">RETIRER</button>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script>
        let config = { lnbitsUrl: '', adminKey: '', invoiceKey: '' };
        let gameState = {
            balance: 0, currentBet: 0, playerCards: [], dealerCards: [],
            gameActive: false, paymentInterval: null
        };

        const suits = ['Hearts', 'Diamonds', 'Clubs', 'Spades'];
        const ranks = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
        const values = { '2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'10':10,'J':10,'Q':10,'K':10,'A':11 };

        function saveConfig() {
            const url = document.getElementById('lnbitsUrl').value.trim();
            const admin = document.getElementById('adminKey').value.trim();
            const invoice = document.getElementById('invoiceKey').value.trim();
            if (!url || !admin || !invoice) return alert('Tous les champs requis');
            config = { lnbitsUrl: url.replace(/\/$/, ''), adminKey: admin, invoiceKey: invoice };
            localStorage.setItem('lbjConfig', JSON.stringify(config));
            document.getElementById('configSection').classList.add('hidden');
            document.getElementById('paymentSection').classList.remove('hidden');
            loadBalance();
        }

        window.onload = () => {
            const saved = localStorage.getItem('lbjConfig');
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('configSection').classList.add('hidden');
                document.getElementById('paymentSection').classList.remove('hidden');
                loadBalance();
            }
        };

        async function loadBalance() {
            try {
                const res = await fetch(`${config.lnbitsUrl}/api/v1/wallet`, { headers: { 'X-Api-Key': config.invoiceKey } });
                const data = await res.json();
                gameState.balance = Math.floor(data.balance / 1000);
                document.getElementById('balance').textContent = gameState.balance.toLocaleString();
                if (gameState.balance > 0) {
                    document.getElementById('withdrawBtn').style.display = 'inline-block';
                    showGame(); // Auto-show game si solde > 0
                }
            } catch (e) { console.error(e); }
        }

        async function buyChips(amount) {
            try {
                const res = await fetch(`${config.lnbitsUrl}/api/v1/payments`, {
                    method: 'POST',
                    headers: { 'X-Api-Key': config.invoiceKey, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount, out: false, memo: `Achat ${amount} sats`, expiry: 3600 })
                });
                const payment = await res.json();

                document.getElementById('invoiceDisplay').classList.remove('hidden');
                document.getElementById('invoiceText').textContent = payment.payment_request;

                // QR FORCÉ
                const qrDiv = document.getElementById('qrCode');
                qrDiv.innerHTML = '';
                QRCode.toCanvas(qrDiv, payment.payment_request, { width: 200, errorCorrectionLevel: 'H' }, (err) => {
                    if (err) console.error(err);
                });

                gameState.paymentInterval = setInterval(async () => {
                    try {
                        const check = await fetch(`${config.lnbitsUrl}/api/v1/payments/${payment.payment_hash}`, { headers: { 'X-Api-Key': config.invoiceKey } });
                        const status = await check.json();
                        if (status.paid) {
                            clearInterval(gameState.paymentInterval);
                            loadBalance();
                            document.getElementById('invoiceDisplay').classList.add('hidden');
                            alert(`+${amount} sats !`);
                            showGame();
                        }
                    } catch (e) {}
                }, 2000);
            } catch (e) { alert('Erreur'); }
        }

        function copyInvoice() {
            const text = document.getElementById('invoiceText').textContent;
            navigator.clipboard.writeText(text).then(() => alert('Copié !')).catch(() => {
                const ta = document.createElement('textarea');
                ta.value = text; document.body.appendChild(ta); ta.select();
                document.execCommand('copy'); document.body.removeChild(ta);
                alert('Copié !');
            });
        }

        function cancelPayment() {
            if (gameState.paymentInterval) clearInterval(gameState.paymentInterval);
            document.getElementById('invoiceDisplay').classList.add('hidden');
        }

        function showGame() {
            document.getElementById('paymentSection').classList.add('hidden');
            document.getElementById('gameSection').classList.remove('hidden');
        }

        function selectBet(amount) {
            if (gameState.gameActive) return;
            gameState.currentBet = amount;
            document.getElementById('currentBet').textContent = amount.toLocaleString();
        }

        function startGame() {
            if (gameState.currentBet === 0 || gameState.currentBet > gameState.balance) return alert('Mise invalide');
            gameState.gameActive = true;
            gameState.playerCards = []; gameState.dealerCards = [];
            document.getElementById('bettingArea').classList.add('hidden');
            document.getElementById('gameButtons').classList.remove('hidden');
            dealCard('player'); dealCard('dealer'); dealCard('player'); dealCard('dealer', true);
        }

        function dealCard(to, hidden = false) {
            const rank = ranks[Math.floor(Math.random() * ranks.length)];
            const suit = suits[Math.floor(Math.random() * suits.length)];
            const card = { rank, suit, value: values[rank], hidden };
            (to === 'player' ? gameState.playerCards : gameState.dealerCards).push(card);
            const el = document.createElement('div');
            el.className = 'w-20 h-28 bg-white rounded-lg shadow-lg flex flex-col items-center justify-center text-2xl font-bold';
            if (!hidden) el.innerHTML = `<div class="text-xs">${suit}</div><div>${rank}</div>`;
            else el.innerHTML = '<div class="text-4xl">?</div>';
            document.getElementById(to + 'Cards').appendChild(el);
        }

        function hit() { if (gameState.gameActive) dealCard('player'); }
        function stand() { gameState.gameActive = false; document.getElementById('gameButtons').classList.add('hidden'); }
        function newGame() { location.reload(); }

        function openWithdrawModal() { if (gameState.balance < 100) return alert('Min 100'); document.getElementById('withdrawModal').style.display = 'block'; }
        function closeWithdrawModal() { document.getElementById('withdrawModal').style.display = 'none'; }

        async function withdraw() {
            const amount = parseInt(document.getElementById('withdrawAmount').value);
            const addr = document.getElementById('withdrawAddress').value.trim();
            if (amount < 100 || amount > gameState.balance || !addr) return alert('Invalide');
            try {
                await fetch(`${config.lnbitsUrl}/api/v1/payments`, {
                    method: 'POST', headers: { 'X-Api-Key': config.adminKey, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ out: true, amount, bolt11: addr })
                });
                loadBalance(); closeWithdrawModal(); alert('Envoyé !');
            } catch (e) { alert('Erreur'); }
        }

        window.onclick = (e) => { if (e.target === document.getElementById('withdrawModal')) closeWithdrawModal(); };
    </script>
</body>
</html>
