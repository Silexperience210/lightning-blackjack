<div class="md:col-span-2">
                    <label class="block text-sm mb-2 text-glow-blue">ADRESSE LIGHTNING (lnurl ou bolt11)</label>
                    <input type="text" id="withdrawAddress" placeholder="lnurl1... ou lightning:..." 
                        class="w-full px-4 py-2 rounded-xl input-glow">
                </div>
                <div class="md:col-span-3">
                    <button onclick="withdraw()" class="w-full btn-glow btn-success py-3 rounded-xl font-semibold">
                        RETIRER MES SATOSHIS
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/lib/qrcode.min.js"></script>
    <script>
        // === CONFIGURATION & ÉTAT GLOBAL ===
        let config = {
            lnbitsUrl: '',
            adminKey: '',
            invoiceKey: ''
        };
        let gameState = {
            balance: 0,
            currentBet: 0,
            selectedChip: 0,
            playerCards: [],
            dealerCards: [],
            gameActive: false,
            canDouble: true,
            paymentInterval: null
        };

        const suits = ['♥', '♦', '♣', '♠'];
        const ranks = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        const values = { '2':2, '3':3, '4':4, '5':5, '6':6, '7':7, '8':8, '9':9, '10':10, 'J':10, 'Q':10, 'K':10, 'A':11 };

        // === SAUVEGARDE CONFIG ===
        function saveConfig() {
            const url = document.getElementById('lnbitsUrl').value.trim();
            const admin = document.getElementById('adminKey').value.trim();
            const invoice = document.getElementById('invoiceKey').value.trim();

            if (!url || !admin || !invoice) {
                alert('⚠️ Tous les champs sont requis !');
                return;
            }

            config = { lnbitsUrl: url.replace(/\/$/, ''), adminKey: admin, invoiceKey: invoice };
            localStorage.setItem('lbjConfig', JSON.stringify(config));
            document.getElementById('configSection').classList.add('hidden');
            document.getElementById('paymentSection').classList.remove('hidden');
            loadBalance();
        }

        // === CHARGEMENT CONFIG ===
        window.onload = () => {
            const saved = localStorage.getItem('lbjConfig');
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('configSection').classList.add('hidden');
                document.getElementById('paymentSection').classList.remove('hidden');
                loadBalance();
            }
        };

        // === CHARGER LE SOLDE ===
        async function loadBalance() {
            try {
                const res = await fetch(`${config.lnbitsUrl}/api/v1/wallet`, {
                    headers: { 'X-Api-Key': config.invoiceKey }
                });
                const data = await res.json();
                gameState.balance = data.balance / 1000; // msats → sats
                document.getElementById('balance').textContent = formatSats(gameState.balance);
            } catch (e) {
                console.error(e);
                alert('Erreur de connexion LNbits');
            }
        }

        // === ACHAT DE JETONS (CORRIGÉ) ===
        async function buyChips(amount) {
            if (!config.lnbitsUrl) return alert('Config requise');

            try {
                const res = await fetch(`${config.lnbitsUrl}/api/v1/payments`, {
                    method: 'POST',
                    headers: {
                        'X-Api-Key': config.invoiceKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: amount,
                        unit: 'sat',
                        memo: `Achat ${amount} sats - Lightning Blackjack`,
                        out: false
                    })
                });
                const payment = await res.json();

                document.getElementById('invoiceDisplay').classList.remove('hidden');
                document.getElementById('invoiceText').textContent = payment.payment_request;

                // Génération QR Code
                document.getElementById('qrCode').innerHTML = '';
                new QRCode(document.getElementById('qrCode'), {
                    text: payment.payment_request,
                    width: 200,
                    height: 200,
                    colorDark: "#0a0a0f",
                    colorLight: "#ffffff"
                });

                // Vérification paiement
                gameState.paymentInterval = setInterval(async () => {
                    try {
                        const check = await fetch(`${config.lnbitsUrl}/api/v1/payments/${payment.payment_hash}`, {
                            headers: { 'X-Api-Key': config.invoiceKey }
                        });
                        const status = await check.json();
                        if (status.paid) {
                            clearInterval(gameState.paymentInterval);
                            gameState.balance += amount;
                            document.getElementById('balance').textContent = formatSats(gameState.balance);
                            document.getElementById('invoiceDisplay').classList.add('hidden');
                            alert(`Paiement reçu ! +${amount} sats`);
                            showGame();
                        }
                    } catch (e) {}
                }, 2000);

            } catch (e) {
                console.error(e);
                alert('Erreur création facture');
            }
        }

        function cancelPayment() {
            if (gameState.paymentInterval) clearInterval(gameState.paymentInterval);
            document.getElementById('invoiceDisplay').classList.add('hidden');
        }

        function copyInvoice() {
            const text = document.getElementById('invoiceText').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('Facture copiée !');
            });
        }

        // === AFFICHAGE JEU ===
        function showPayment() {
            document.getElementById('paymentSection').classList.remove('hidden');
            document.getElementById('gameSection').classList.add('hidden');
        }

        function showGame() {
            document.getElementById('paymentSection').classList.add('hidden');
            document.getElementById('gameSection').classList.remove('hidden');
            loadBalance();
        }

        // === GESTION DES MISES ===
        function selectBet(amount) {
            if (gameState.gameActive) return;
            gameState.selectedChip = amount;
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('chip-selected'));
            event.target.classList.add('chip-selected');
            gameState.currentBet = amount;
            document.getElementById('currentBet').textContent = formatSats(amount);
        }

        function clearBet() {
            gameState.currentBet = 0;
            gameState.selectedChip = 0;
            document.getElementById('currentBet').textContent = '0';
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('chip-selected'));
        }

        // === DÉMARRER PARTIE ===
        function startGame() {
            if (gameState.currentBet === 0 || gameState.currentBet > gameState.balance) {
                alert('Mise invalide ou solde insuffisant');
                return;
            }
            if (gameState.gameActive) return;

            gameState.gameActive = true;
            gameState.playerCards = [];
            gameState.dealerCards = [];
            gameState.canDouble = true;

            document.getElementById('bettingArea').classList.add('hidden');
            document.getElementById('gameButtons').classList.remove('hidden');
            document.getElementById('newGameButton').classList.add('hidden');
            document.getElementById('gameMessage').textContent = '';
            document.getElementById('gameSubmessage').textContent = '';

            dealCard('player'); dealCard('dealer');
            dealCard('player'); dealCard('dealer', true); // dos visible

            updateScores();
            if (calculateScore(gameState.playerCards) === 21) {
                setTimeout(stand, 800);
            }
        }

        // === TIRER UNE CARTE ===
        function dealCard(to, hidden = false) {
            const rank = ranks[Math.floor(Math.random() * ranks.length)];
            const suit = suits[Math.floor(Math.random() * suits.length)];
            const card = { rank, suit, value: values[rank], hidden };

            if (to === 'player') gameState.playerCards.push(card);
            else gameState.dealerCards.push(card);

            const cardEl = document.createElement('div');
            cardEl.className = `card ${hidden ? 'card-back' : (suit === '♥' || suit === '♦' ? 'card-red' : 'card-black')}`;
            if (!hidden) {
                cardEl.innerHTML = `
                    <div class="card-suit">${suit}</div>
                    <div>${rank}</div>
                    <div class="card-suit rotate-180">${suit}</div>
                `;
            } else {
                cardEl.innerHTML = `<div>⚡</div>`;
            }
            document.getElementById(to + 'Cards').appendChild(cardEl);
        }

        // === CALCUL SCORE ===
        function calculateScore(cards) {
            let score = 0, aces = 0;
            cards.forEach(c => {
                if (!c.hidden) {
                    score += c.value;
                    if (c.rank === 'A') aces++;
                }
            });
            while (score > 21 && aces > 0) {
                score -= 10; aces--;
            }
            return score;
        }

        function updateScores() {
            document.getElementById('playerScore').textContent = calculateScore(gameState.playerCards);
            const dealerScore = calculateScore(gameState.dealerCards);
            document.getElementById('dealerScore').textContent = dealerScore > 0 ? dealerScore : '?';
        }

        // === HIT ===
        function hit() {
            if (!gameState.gameActive || !gameState.canDouble) return;
            dealCard('player');
            updateScores();
            gameState.canDouble = false;
            document.getElementById('doubleBtn').disabled = true;

            if (calculateScore(gameState.playerCards) > 21) {
                endGame('bust');
            }
        }

        // === STAND ===
        function stand() {
            gameState.gameActive = false;
            document.getElementById('gameButtons').classList.add('hidden');

            // Révéler carte cachée
            const hiddenCard = document.querySelector('#dealerCards .card-back');
            if (hiddenCard) {
                const card = gameState.dealerCards.find(c => c.hidden);
                hiddenCard.classList.remove('card-back');
                hiddenCard.classList.add(card.suit === '♥' || card.suit === '♦' ? 'card-red' : 'card-black');
                hiddenCard.innerHTML = `
                    <div class="card-suit">${card.suit}</div>
                    <div>${card.rank}</div>
                    <div class="card-suit rotate-180">${card.suit}</div>
                `;
                card.hidden = false;
            }

            updateScores();
            dealerPlay();
        }

        // === CROUPIER JOUE ===
        function dealerPlay() {
            let score = calculateScore(gameState.dealerCards);
            const play = () => {
                if (score < 17) {
                    setTimeout(() => {
                        dealCard('dealer');
                        updateScores();
                        score = calculateScore(gameState.dealerCards);
                        if (score <= 21) play();
                        else endGame();
                    }, 800);
                } else {
                    endGame();
                }
            };
            play();
        }

        // === DOUBLER ===
        function doubleDown() {
            if (!gameState.canDouble || gameState.currentBet * 2 > gameState.balance) return;
            gameState.currentBet *= 2;
            document.getElementById('currentBet').textContent = formatSats(gameState.currentBet);
            gameState.canDouble = false;
            document.getElementById('doubleBtn').disabled = true;
            hit();
            if (calculateScore(gameState.playerCards) <= 21) stand();
        }

        // === FIN DE PARTIE ===
        function endGame(reason = '') {
            const playerScore = calculateScore(gameState.playerCards);
            const dealerScore = calculateScore(gameState.dealerCards);
            let message = '', sub = '', win = 0;

            if (reason === 'bust' || playerScore > 21) {
                message = 'DÉPASSÉ !'; sub = 'Vous avez perdu.';
            } else if (dealerScore > 21) {
                message = 'CROUPIER DÉPASSÉ !'; sub = 'Vous gagnez !';
                win = gameState.currentBet * (playerScore === 21 && gameState.playerCards.length === 2 ? 1.5 : 1);
            } else if (playerScore > dealerScore) {
                message = 'VICTOIRE !'; sub = 'Félicitations !';
                win = gameState.currentBet * (playerScore === 21 && gameState.playerCards.length === 2 ? 1.5 : 1);
            } else if (playerScore < dealerScore) {
                message = 'DÉFAITE'; sub = 'Le croupier gagne.';
            } else {
                message = 'ÉGALITÉ'; sub = 'Mise remboursée.';
                win = gameState.currentBet;
            }

            gameState.balance += win;
            gameState.balance -= gameState.currentBet * (win === 0 ? 1 : 0);

            document.getElementById('gameMessage').textContent = message;
            document.getElementById('gameMessage').className = win > 0 ? 'text-glow-green' : 'text-glow-red';
            document.getElementById('gameSubmessage').textContent = sub;
            document.getElementById('balance').textContent = formatSats(gameState.balance);
            document.getElementById('newGameButton').classList.remove('hidden');

            // Nettoyage
            setTimeout(() => {
                document.getElementById('dealerCards').innerHTML = '';
                document.getElementById('playerCards').innerHTML = '';
            }, 3000);
        }

        // === NOUVELLE PARTIE ===
        function newGame() {
            gameState.gameActive = false;
            gameState.currentBet = 0;
            gameState.playerCards = [];
            gameState.dealerCards = [];
            clearBet();
            document.getElementById('bettingArea').classList.remove('hidden');
            document.getElementById('gameButtons').classList.add('hidden');
            document.getElementById('newGameButton').classList.add('hidden');
            document.getElementById('doubleBtn').disabled = false;
            document.getElementById('dealerScore').textContent = '';
            document.getElementById('playerScore').textContent = '';
        }

        // === RETRAIT ===
        async function withdraw() {
            const amount = parseInt(document.getElementById('withdrawAmount').value);
            const address = document.getElementById('withdrawAddress').value.trim();

            if (!amount || amount > gameState.balance || amount < 100) {
                alert('Montant invalide (min 100 sats)');
                return;
            }
            if (!address) {
                alert('Adresse requise');
                return;
            }

            try {
                const res = await fetch(`${config.lnbitsUrl}/api/v1/payments`, {
                    method: 'POST',
                    headers: {
                        'X-Api-Key': config.adminKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: amount,
                        unit: 'sat',
                        memo: `Retrait Lightning Blackjack`,
                        bolt11: address.includes('lightning:') ? address.split(':')[1] : address,
                        out: true
                    })
                });
                const data = await res.json();
                if (data.payment_hash) {
                    gameState.balance -= amount;
                    document.getElementById('balance').textContent = formatSats(gameState.balance);
                    alert(`Retrait envoyé ! ${amount} sats`);
                    document.getElementById('withdrawAmount').value = '';
                    document.getElementById('withdrawAddress').value = '';
                } else {
                    alert('Erreur retrait');
                }
            } catch (e) {
                console.error(e);
                alert('Erreur LNbits');
            }
        }

        // === UTILITAIRES ===
        function formatSats(n) {
            return n.toLocaleString('fr-FR');
        }

        // Animation d'entrée des cartes
        document.querySelectorAll('.card').forEach((c, i) => {
            c.style.animationDelay = `${i * 0.1}s`;
        });
    </script>
</body>
</html>
