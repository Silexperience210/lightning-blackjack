<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° LIGHTNING BLACKJACK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* [M√™me styles que pr√©c√©demment ‚Äì inchang√©s pour brevit√©, colle-les du code pr√©c√©dent] */
        * { font-family: 'Orbitron', sans-serif; }
        body { background: #0a0a0f; overflow-x: hidden; }
        /* ... (copie tous les styles du code pr√©c√©dent ici) ... */
        .lightning-bg { /* ... */ }
        /* Ajoute le reste des styles si besoin */
    </style>
</head>
<body>
    <div class="lightning-bg"></div>

    <!-- [M√™me HTML structure que pr√©c√©demment ‚Äì config, payment, game, modal] -->
    <!-- Configuration Section -->
    <div id="configSection" class="relative z-10 max-w-2xl mx-auto p-4 mt-10">
        <!-- [Copie du pr√©c√©dent] -->
    </div>

    <!-- Paiement Section (ajout: affichage montant attendu) -->
    <div id="paymentSection" class="hidden relative z-10 max-w-3xl mx-auto p-4 mt-10">
        <div class="glow-container rounded-3xl p-8">
            <h2 class="text-4xl font-black text-center mb-3 text-glow-yellow">üí∞ ACHETER DES JETONS</h2>
            <p class="text-center text-glow-purple text-lg mb-8">Rechargez votre compte en Satoshis</p>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <!-- Chips buttons inchang√©s -->
                <div class="glow-container rounded-2xl p-6 cursor-pointer hover:scale-105 transition-transform text-center" onclick="buyChips(2100)"> <!-- etc. --> </div>
                <!-- ... -->
            </div>

            <div id="invoiceDisplay" class="hidden">
                <div class="glow-container rounded-2xl p-6 mb-4">
                    <h3 class="text-2xl font-bold mb-4 text-center text-glow-yellow">SCANNEZ POUR PAYER</h3>
                    <div id="qrAmount" class="text-center text-glow-green text-xl mb-2"></div> <!-- Nouveau: montant attendu -->
                    <div id="qrCode" class="flex justify-center mb-4 qr-container mx-auto w-fit"></div>
                    <div class="bg-gray-900 p-3 rounded-xl break-all text-sm font-mono text-gray-300" id="invoiceText"></div>
                    <button onclick="copyInvoice()" class="w-full mt-4 btn-glow btn-action py-3 rounded-xl">üìã COPIER LA FACTURE</button>
                </div>
                <div class="text-center">
                    <div class="animate-pulse text-glow-yellow text-xl mb-2">‚è≥ EN ATTENTE DU PAIEMENT...</div>
                    <button onclick="cancelPayment()" class="text-gray-400 hover:text-glow-yellow transition">Annuler</button>
                </div>
            </div>

            <!-- ... reste inchang√© -->
        </div>
    </div>

    <!-- [Game Section et Modal inchang√©s ‚Äì copie du pr√©c√©dent] -->

    <!-- Scripts (CORRIG√â ICI) -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/lib/qrcode.min.js"></script>
    <script>
        // [√âtat global inchang√©]

        // === CHARGER LE SOLDE (inchang√©, mais appel msats ‚Üí sats) ===
        async function loadBalance() {
            try {
                const res = await fetch(`${config.lnbitsUrl}/api/v1/wallet`, {
                    headers: { 'X-Api-Key': config.invoiceKey }
                });
                const data = await res.json();
                gameState.balance = Math.round(data.balance / 1000); // msats ‚Üí sats, arrondi
                document.getElementById('balance').textContent = formatSats(gameState.balance);
                document.getElementById('modalBalance').textContent = formatSats(gameState.balance);
                if (gameState.balance > 0) document.getElementById('withdrawBtn').style.display = 'inline-block';
            } catch (e) {
                console.error(e);
                alert('Erreur de connexion LNbits');
            }
        }

        // === ACHAT DE JETONS (CORRIG√â : amount en SATS direct, + check montant re√ßu) ===
        async function buyChips(amount) {
            if (!config.lnbitsUrl) return alert('Config requise');

            try {
                const res = await fetch(`${config.lnbitsUrl}/api/v1/payments`, {
                    method: 'POST',
                    headers: {
                        'X-Api-Key': config.invoiceKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: amount,  // ‚Üê CORRIG√â : sats direct (API LNbits le g√®re en msats interne)
                        memo: `Achat ${amount} sats - Lightning Blackjack`,
                        out: false,
                        expiry: 3600  // 1h pour plus de flex
                    })
                });
                const payment = await res.json();

                document.getElementById('invoiceDisplay').classList.remove('hidden');
                document.getElementById('invoiceText').textContent = payment.payment_request;
                document.getElementById('qrAmount').textContent = `Montant attendu : ${formatSats(amount)} sats`;  // ‚Üê Nouveau

                // QR
                document.getElementById('qrCode').innerHTML = '';
                new QRCode(document.getElementById('qrCode'), {
                    text: payment.payment_request,
                    width: 200,
                    height: 200,
                    colorDark: "#0a0a0f",
                    colorLight: "#ffffff"
                });

                // Polling avec check montant (CORRIG√â)
                gameState.paymentInterval = setInterval(async () => {
                    try {
                        const check = await fetch(`${config.lnbitsUrl}/api/v1/payments/${payment.payment_hash}`, {
                            headers: { 'X-Api-Key': config.invoiceKey }
                        });
                        const status = await check.json();
                        if (status.paid) {
                            const receivedSats = Math.round(status.amount_received_msat / 1000);
                            if (receivedSats !== amount) {
                                alert(`‚ö†Ô∏è Montant re√ßu diff√©rent : ${receivedSats} sats au lieu de ${amount}. V√©rifie ton wallet.`);
                            } else {
                                clearInterval(gameState.paymentInterval);
                                loadBalance();  // Sync solde
                                document.getElementById('invoiceDisplay').classList.add('hidden');
                                alert(`‚úÖ Paiement re√ßu ! +${amount} sats`);
                                showGame();
                            }
                        }
                    } catch (e) {
                        console.error(e);
                    }
                }, 2000);

            } catch (e) {
                console.error(e);
                alert('Erreur cr√©ation facture : ' + e.message);
            }
        }

        // === RETRAIT (CORRIG√â : amount en SATS direct) ===
        async function withdraw() {
            const amount = parseInt(document.getElementById('withdrawAmount').value);
            const address = document.getElementById('withdrawAddress').value.trim();

            if (!amount || amount > gameState.balance || amount < 100) return alert('Montant invalide (min 100 sats)');
            if (!address) return alert('Adresse requise');

            try {
                const res = await fetch(`${config.lnbitsUrl}/api/v1/payments`, {
                    method: 'POST',
                    headers: {
                        'X-Api-Key': config.adminKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        out: true,
                        amount: amount,  // ‚Üê CORRIG√â : sats direct
                        memo: `Retrait Lightning Blackjack - ${amount} sats`,
                        bolt11: address.includes('lightning:') ? address.replace('lightning:', '') : address,
                        lnurl: address.startsWith('lnurl') ? address : undefined
                    })
                });
                const data = await res.json();
                if (data.payment_hash) {
                    loadBalance();
                    alert(`‚ö° Retrait de ${amount} sats envoy√© !`);
                    closeWithdrawModal();
                    document.getElementById('withdrawAmount').value = '';
                    document.getElementById('withdrawAddress').value = '';
                } else {
                    alert('Erreur retrait');
                }
            } catch (e) {
                console.error(e);
                alert('Erreur LNbits : ' + e.message);
            }
        }

        // [Reste des fonctions JS inchang√©es : saveConfig, showGame, game logic, etc.]
        // Copie tout du code pr√©c√©dent pour le jeu (dealCard, hit, etc.)

        function formatSats(n) {
            return n.toLocaleString('fr-FR');
        }

        // [Fin du script]
    </script>
</body>
</html>
