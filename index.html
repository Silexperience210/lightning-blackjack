<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIGHTNING BLACKJACK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Orbitron', sans-serif; }
        body { background: #0a0a0f; overflow-x: hidden; }
        .lightning-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;
            background: radial-gradient(ellipse at 20% 30%, rgba(124, 58, 237, 0.15) 0%, transparent 50%),
                        radial-gradient(ellipse at 80% 70%, rgba(234, 179, 8, 0.15) 0%, transparent 50%);
            animation: pulse-bg 8s ease-in-out infinite;
        }
        @keyframes pulse-bg { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
        .glow-container {
            background: rgba(10, 10, 15, 0.9);
            border: 2px solid;
            border-image: linear-gradient(135deg, #fbbf24, #7c3aed, #3b82f6) 1;
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.3), 0 0 60px rgba(124, 58, 237, 0.2),
                        inset 0 0 30px rgba(251, 191, 36, 0.1);
            position: relative; z-index: 1;
        }
        .card { width: 85px; height: 120px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 32px; font-weight: 900; margin: 5px; background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(240,240,255,0.95) 100%);
            position: relative; transition: all 0.3s ease; box-shadow: 0 8px 32px rgba(0,0,0,0.5), 0 0 20px rgba(251,191,36,0.4); }
        .card-back { background: linear-gradient(135deg, #1e1b4b 0%, #7c3aed 50%, #1e1b4b 100%); color: #fbbf24; }
        .chip { width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: 900; font-size: 18px; cursor: pointer; transition: all 0.3s ease; border: 3px solid rgba(255,255,255,0.3); }
        .chip-selected { transform: scale(1.25); border: 4px solid #fbbf24; animation: chip-pulse 1s infinite; }
        @keyframes chip-pulse { 0%, 100% { box-shadow: 0 0 20px currentColor; } 50% { box-shadow: 0 0 40px currentColor; } }
        .btn-glow { position: relative; overflow: hidden; font-weight: 900; text-transform: uppercase; letter-spacing: 2px; transition: all 0.3s ease; }
        .btn-primary { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #0a0a0f; border: 2px solid #fbbf24; }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: white; border: 2px solid #10b981; }
        .text-glow-yellow { color: #fbbf24; text-shadow: 0 0 10px #fbbf24, 0 0 20px #fbbf24; }
        .text-glow-purple { color: #a78bfa; text-shadow: 0 0 10px #7c3aed; }
        .input-glow { background: rgba(17,24,39,0.8); border: 2px solid rgba(251,191,36,0.3); color: white; }
        .input-glow:focus { outline: none; border-color: #fbbf24; box-shadow: 0 0 20px rgba(251,191,36,0.5); }
        .qr-container { background: white; padding: 15px; border-radius: 15px; }
        #withdrawModal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        .modal-content { background: rgba(10,10,15,0.95); margin: 10% auto; padding: 30px; border-radius: 20px; width: 90%; max-width: 500px; box-shadow: 0 0 50px rgba(251,191,36,0.5); }
        .close { color: #fbbf24; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div class="lightning-bg"></div>

    <!-- CONFIG -->
    <div id="configSection" class="relative z-10 max-w-2xl mx-auto p-4 mt-10">
        <div class="glow-container rounded-3xl p-8">
            <h1 class="text-5xl font-black text-center mb-3 text-glow-yellow">LIGHTNING BLACKJACK</h1>
            <p class="text-center text-glow-purple text-lg mb-8">Configuration LNbits</p>
            <div class="space-y-5">
                <input type="text" id="lnbitsUrl" placeholder="https://legend.lnbits.com" class="w-full px-4 py-3 rounded-xl input-glow text-lg">
                <input type="password" id="adminKey" placeholder="Clé API Admin" class="w-full px-4 py-3 rounded-xl input-glow text-lg">
                <input type="password" id="invoiceKey" placeholder="Clé API Invoice" class="w-full px-4 py-3 rounded-xl input-glow text-lg">
                <button onclick="saveConfig()" class="w-full btn-glow btn-primary py-4 rounded-xl text-lg">ACTIVER</button>
            </div>
        </div>
    </div>

    <!-- PAIEMENT -->
    <div id="paymentSection" class="hidden relative z-10 max-w-3xl mx-auto p-4 mt-10">
        <div class="glow-container rounded-3xl p-8">
            <h2 class="text-4xl font-black text-center mb-3 text-glow-yellow">ACHETER DES JETONS</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="glow-container rounded-2xl p-6 cursor-pointer hover:scale-105 text-center" onclick="buyChips(2100)">
                    <div class="text-3xl font-black text-glow-yellow">2,100</div><div class="text-glow-purple">sats</div>
                </div>
                <div class="glow-container rounded-2xl p-6 cursor-pointer hover:scale-105 text-center" onclick="buyChips(5000)">
                    <div class="text-3xl font-black text-glow-yellow">5,000</div><div class="text-glow-purple">sats</div>
                </div>
                <div class="glow-container rounded-2xl p-6 cursor-pointer hover:scale-105 text-center" onclick="buyChips(10000)">
                    <div class="text-3xl font-black text-glow-yellow">10,000</div><div class="text-glow-purple">sats</div>
                </div>
                <div class="glow-container rounded-2xl p-6 cursor-pointer hover:scale-105 text-center" onclick="buyChips(21000)">
                    <div class="text-3xl font-black text-glow-yellow">21,000</div><div class="text-glow-purple">sats</div>
                </div>
            </div>

            <div id="invoiceDisplay" class="hidden text-center">
                <div class="glow-container rounded-2xl p-6 mb-4 inline-block">
                    <h3 class="text-2xl font-bold mb-4 text-glow-yellow">SCANNEZ LE QR CODE</h3>
                    <div id="qrCode" class="mx-auto"></div>
                    <p class="mt-4 text-sm text-glow-purple break-all" id="invoiceText"></p>
                    <button onclick="copyInvoice()" class="mt-4 w-full btn-glow btn-primary py-3 rounded-xl">COPIER LA FACTURE</button>
                </div>
                <div class="mt-4">
                    <div class="animate-pulse text-glow-yellow">EN ATTENTE DU PAIEMENT...</div>
                    <button onclick="cancelPayment()" class="text-gray-400 hover:text-glow-yellow">Annuler</button>
                </div>
            </div>

            <div class="text-center mt-6">
                <button onclick="showGame()" class="text-glow-purple hover:text-glow-yellow underline">J'ai des jetons → JOUER</button>
            </div>
        </div>
    </div>

    <!-- JEU -->
    <div id="gameSection" class="hidden relative z-10 max-w-6xl mx-auto p-4 mt-10 mb-10">
        <div class="glow-container rounded-3xl p-6 mb-6">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <div><h1 class="text-4xl font-black text-glow-yellow">LIGHTNING BLACKJACK</h1></div>
                <div class="text-right">
                    <div class="text-sm text-glow-purple">SOLDE</div>
                    <div class="text-4xl font-black text-glow-yellow" id="balance">0</div>
                    <button onclick="showPayment()" class="btn-glow btn-primary px-4 py-2 text-sm mr-2">+ ACHETER</button>
                    <button onclick="openWithdrawModal()" class="btn-glow btn-success px-4 py-2 text-sm" id="withdrawBtn" style="display:none;">RETRAIT</button>
                </div>
            </div>
        </div>

        <!-- Croupier, Joueur, Mises, Boutons, Règles -->
        <!-- (Copie du jeu précédent – inchangé pour brevité) -->
        <!-- ... [insère ici tout le HTML du jeu du code précédent] ... -->
    </div>

    <!-- MODAL RETRAIT -->
    <div id="withdrawModal">
        <div class="modal-content">
            <span class="close" onclick="closeWithdrawModal()">×</span>
            <h3 class="text-2xl font-bold mb-4 text-center text-glow-yellow">RETRAIT</h3>
            <input type="number" id="withdrawAmount" placeholder="1000" class="w-full px-4 py-2 rounded-xl input-glow mb-3">
            <input type="text" id="withdrawAddress" placeholder="lnurl ou bolt11" class="w-full px-4 py-2 rounded-xl input-glow mb-4">
            <button onclick="withdraw()" class="w-full btn-glow btn-success py-3 rounded-xl">RETIRER</button>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/lib/qrcode.min.js"></script>
    <script>
        let config = { lnbitsUrl: '', adminKey: '', invoiceKey: '' };
        let gameState = { balance: 0, currentBet: 0, paymentInterval: null };

        function saveConfig() {
            const url = document.getElementById('lnbitsUrl').value.trim();
            const admin = document.getElementById('adminKey').value.trim();
            const invoice = document.getElementById('invoiceKey').value.trim();
            if (!url || !admin || !invoice) return alert('Tous les champs requis');
            config = { lnbitsUrl: url.replace(/\/$/, ''), adminKey: admin, invoiceKey: invoice };
            localStorage.setItem('lbjConfig', JSON.stringify(config));
            document.getElementById('configSection').classList.add('hidden');
            document.getElementById('paymentSection').classList.remove('hidden');
            loadBalance();
        }

        window.onload = () => {
            const saved = localStorage.getItem('lbjConfig');
            if (saved) { config = JSON.parse(saved); document.getElementById('configSection').classList.add('hidden'); document.getElementById('paymentSection').classList.remove('hidden'); loadBalance(); }
        };

        async function loadBalance() {
            try {
                const res = await fetch(`${config.lnbitsUrl}/api/v1/wallet`, { headers: { 'X-Api-Key': config.invoiceKey } });
                const data = await res.json();
                gameState.balance = Math.floor(data.balance / 1000); // msats → sats
                document.getElementById('balance').textContent = gameState.balance.toLocaleString();
                if (gameState.balance > 0) document.getElementById('withdrawBtn').style.display = 'inline-block';
            } catch (e) { console.error(e); }
        }

        // ACHAT – MONTANTS EN SATS PURS
        async function buyChips(amount) {
            try {
                const res = await fetch(`${config.lnbitsUrl}/api/v1/payments`, {
                    method: 'POST',
                    headers: { 'X-Api-Key': config.invoiceKey, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: amount, memo: `Achat ${amount} sats`, out: false, expiry: 3600 })
                });
                const payment = await res.json();

                document.getElementById('invoiceDisplay').classList.remove('hidden');
                document.getElementById('invoiceText').textContent = payment.payment_request;

                // QR CODE – FORCÉ
                const qrDiv = document.getElementById('qrCode');
                qrDiv.innerHTML = ''; // Nettoie
                new QRCode(qrDiv, {
                    text: payment.payment_request,
                    width: 256,
                    height: 256,
                    colorDark: "#000000",
                    colorLight: "#ffffff"
                });

                // POLLING
                gameState.paymentInterval = setInterval(async () => {
                    try {
                        const check = await fetch(`${config.lnbitsUrl}/api/v1/payments/${payment.payment_hash}`, { headers: { 'X-Api-Key': config.invoiceKey } });
                        const status = await check.json();
                        if (status.paid) {
                            clearInterval(gameState.paymentInterval);
                            loadBalance();
                            document.getElementById('invoiceDisplay').classList.add('hidden');
                            alert(`+${amount} sats reçus !`);
                            showGame();
                        }
                    } catch (e) {}
                }, 2000);
            } catch (e) { alert('Erreur facture'); }
        }

        function copyInvoice() {
            const text = document.getElementById('invoiceText').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('Facture copiée dans le presse-papier !');
            }).catch(() => {
                // Fallback si HTTPS requis
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('Facture copiée !');
            });
        }

        function cancelPayment() {
            if (gameState.paymentInterval) clearInterval(gameState.paymentInterval);
            document.getElementById('invoiceDisplay').classList.add('hidden');
        }

        function showGame() {
            document.getElementById('paymentSection').classList.add('hidden');
            document.getElementById('gameSection').classList.remove('hidden');
        }

        function openWithdrawModal() {
            if (gameState.balance < 100) return alert('Solde trop bas');
            document.getElementById('withdrawModal').style.display = 'block';
        }

        function closeWithdrawModal() {
            document.getElementById('withdrawModal').style.display = 'none';
        }

        async function withdraw() {
            const amount = parseInt(document.getElementById('withdrawAmount').value);
            const addr = document.getElementById('withdrawAddress').value.trim();
            if (amount < 100 || amount > gameState.balance || !addr) return alert('Montant ou adresse invalide');
            try {
                const res = await fetch(`${config.lnbitsUrl}/api/v1/payments`, {
                    method: 'POST',
                    headers: { 'X-Api-Key': config.adminKey, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ out: true, amount: amount, bolt11: addr, memo: 'Retrait' })
                });
                const data = await res.json();
                if (data.payment_hash) {
                    loadBalance();
                    alert('Retrait envoyé !');
                    closeWithdrawModal();
                }
            } catch (e) { alert('Erreur retrait'); }
        }

        // Empêche fermeture modal par clic extérieur
        window.onclick = (e) => { if (e.target === document.getElementById('withdrawModal')) closeWithdrawModal(); };
    </script>
</body>
</html>
